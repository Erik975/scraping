<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Visualisation des articles</title>
<style>
/* --- Reset / Base --- */
* {
  box-sizing: border-box;
}
#narratives:empty {
  display: none;
}
#narratives {
  background:#fff;
  border-radius:14px;
  padding:24px;
  margin-top:20px;
  rgb(0 122 255 / 0.15);
  max-height: 600px;
  overflow-y: auto;
}
   
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
    Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  margin: 40px auto;
  max-width: 1000px;
  background: linear-gradient(135deg, #f5f7fa, #e9eff5);
  color: #1d1d1f;
}

h2 {
  font-weight: 700;
  font-size: 2.2rem;
  margin-bottom: 20px;
  color: #111;
  text-align: center;
}

/* --- Toolbar --- */
.toolbar {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 10px 0 15px 0;
  width: 100%;
}

.toolbar-row {
  display: flex;
  gap: 15px;
  width: 100%;
}

.toolbar-row > div {
  flex: 1; /* les deux prennent la m√™me largeur */
  display: flex;
  flex-direction: column;
}

.toolbar-row label {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 5px;
  color: #333;
}

/* --- Select commun --- */
select {
  padding: 10px 12px;
  border: 1.5px solid #d2d7df;
  border-radius: 10px;
  font-size: 1rem;
  background: white;
  color: #1d1d1f;
  transition: border-color 0.3s ease;
  margin-bottom: 10px;
  width: 100%;
}

select:focus {
  border-color: #007aff;
  outline: none;
}

/* --- Selecteur Article --- */
#articleSelect {
  width: 100%;
  margin-top: 5px;
}

/* --- Boutons --- */
.button-bar {
  display: flex;
  justify-content: center; /* Centre les boutons */
  gap: 12px;
  margin: 15px 0;
}

.button-bar button {
  background: #007aff;
  border: none;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  font-size: 1rem;
  padding: 10px 18px;
  cursor: pointer;
  box-shadow: 0 3px 10px rgba(0, 122, 255, 0.3);
  transition: background-color 0.3s ease, transform 0.15s ease;
}

.button-bar button:hover:not(:disabled) {
  background: #005ecb;
  transform: translateY(-2px);
}

.button-bar button:disabled {
  background: #a7a7a7;
  box-shadow: none;
  cursor: not-allowed;
}

/* --- Viewer plus grand --- */
#viewer {
  background: white;
  border-radius: 16px;
  box-shadow: 0 6px 18px rgb(0 0 0 / 0.12);
  padding: 28px;
  font-size: 1.15rem;
  line-height: 1.7;
  color: #1d1d1f;
  height: 500px; /* plus grand */
  overflow-y: auto;
  white-space: pre-wrap;
  margin-top: 40px;
}

/* --- R√©sum√© --- */
#summary {
  background: #f0f5ff;
  border-radius: 14px;
  padding: 24px;
  font-size: 1.05rem;
  line-height: 1.8;
  color: #1c1c1e;
  box-shadow: 0 5px 16px rgb(0 122 255 / 0.15);
  opacity: 0;
  max-height: 0;
  overflow: hidden;
  transition: opacity 0.5s ease, max-height 0.7s ease;
}

#summary.visible {
  opacity: 1;
  max-height: 600px;
  overflow-y: auto;
  margin-top: 20px;
}

#summary h3 {
  margin-top: 12px;
  margin-bottom: 10px;
  color: #0056b3;
}

#summary ul {
  padding-left: 20px;
  margin-top: 8px;
  margin-bottom: 14px;
}

#summary li {
  margin-bottom: 6px;
}

/* Scrollbars */
#viewer::-webkit-scrollbar,
#summary::-webkit-scrollbar {
  width: 8px;
}

#viewer::-webkit-scrollbar-thumb,
#summary::-webkit-scrollbar-thumb {
  background-color: rgba(0, 122, 255, 0.3);
  border-radius: 8px;
}

#viewer::-webkit-scrollbar-track,
#summary::-webkit-scrollbar-track {
  background-color: transparent;
}

</style>
</head>
<body>

<!-- Toolbar avec Provider + Date -->
<div class="toolbar">
  <div class="toolbar-row">
    <div>
      <label for="providerSelect">Provider :</label>
      <select id="providerSelect">
        <option value="">-- Choisir un provider --</option>
      </select>
    </div>
    <div>
      <label for="dateSelect">Date :</label>
      <select id="dateSelect" disabled>
        <option value="">-- Choisir une date --</option>
      </select>
    </div>
  </div>
</div>

<!-- Selecteur Article -->
<label for="articleSelect">Article :</label>
<select id="articleSelect" disabled>
  <option value="">-- Choisir un article --</option>
</select>

<!-- Boutons centr√©s -->
<div class="button-bar">
  <button id="prevBtn" disabled>‚Üê Pr√©c√©dent</button>
  <button id="nextBtn" disabled>Suivant ‚Üí</button>
  <button id="summarizeBtn" disabled>üìù R√©sumer</button>
  <button id="generateNarrativesBtn" disabled>üó£Ô∏è G√©n√©rer narratifs</button>
</div>

<!-- Viewer + R√©sum√© -->
<div id="viewer">S√©lectionnez un article pour l‚Äôafficher ici.</div>
<div id="summary"></div>
<div id="narratives"></div>


<script>
// ton script JS reste identique
</script>

</body>
</html>





<script>
/* ==== CONFIGURATION API KEYS ==== */
const API_KEYS = [
  "AIzaSyB-ZFSra3QAwh1YO0wtsuj6Xx-I99LlrV4",
  "AIzaSyB9qetZJ90xA9bJV-zW3NIE8kG8om2g7hI",
  "AIzaSyDjivt4xeVRSvZfT5YoUoD1k5CyuD8gquA",
  "AIzaSyA7ePuU7yv-s2uZyZrzpZibiTAzsMSbXo4U",
  "AIzaSyAe0QdwGUZ4aODx_kRob9ixYzc2MM6sMc4U",
  "AIzaSyBy3zDzNnnV5h2AWPnCHvb8jmzs4JM9QM0",
  "AIzaSyB0xokwOS_Buk2ExKeZVJ93H7o0PyU-n3k"
];

const NARRATIVE_STYLES = {
  "üì∞ S√©rieux": "R√©dige un tweet informatif, neutre et journalistique. Concentre-toi sur les faits.",
  "üòÇ Humour": "Fais un tweet dr√¥le ou ironique sur ce sujet, sans tomber dans l‚Äôoffensant.",
  "‚ö†Ô∏è D√©nonciation": "Adopte un ton engag√© et d√©nonciateur comme si tu alertais ton audience.",
  "ü§î Vulgarisation": "Explique ce sujet simplement, comme √† un ado, avec des mots accessibles.",
  "üî• Buzz / Punchline": "Propose un tweet percutant, court, qui pourrait devenir viral."
};

let currentKeyIndex = 0;

let data = null;
let currentArticles = [];
let currentIndex = -1;

/* ==== ELEMENTS ==== */
const providerSelect = document.getElementById('providerSelect');
const dateSelect = document.getElementById('dateSelect');
const articleSelect = document.getElementById('articleSelect');
const viewer = document.getElementById('viewer');
const summary = document.getElementById('summary');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const summarizeBtn = document.getElementById('summarizeBtn');

/* ==== URL PARAMS ==== */
function getUrlParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

function formatDateFromUrl(dateStr) {
  if (!dateStr || dateStr.length !== 8) return null;
  return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
}

/* ==== FETCH DATA ==== */
fetch('data.json')
  .then(response => response.json())
  .then(json => {
    data = json;
    initSelectors();
  })
  .catch(err => {
    viewer.textContent = 'Erreur de chargement des donn√©es : ' + err.message;
  });

/* ==== INITIALISATION SELECTEURS ==== */
function initSelectors() {
  const providers = [...new Set(data.articles.map(a => a.provider))].sort();

  providers.forEach(provider => {
    const opt = document.createElement('option');
    opt.value = provider;
    opt.textContent = provider;
    providerSelect.appendChild(opt);
  });

  const urlProvider = getUrlParam('source');
  const urlDateRaw = getUrlParam('date');
  const urlDate = formatDateFromUrl(urlDateRaw);

  if (urlProvider && providers.includes(urlProvider)) {
    providerSelect.value = urlProvider;
    updateDates(urlProvider, urlDate);
  }
}

function updateDates(provider, selectedDate = null) {
  dateSelect.innerHTML = '<option value="">-- Choisir une date --</option>';
  articleSelect.innerHTML = '<option value="">-- Choisir un article --</option>';
  articleSelect.disabled = true;
  viewer.textContent = 'S√©lectionnez un article pour l‚Äôafficher ici.';
  summary.classList.remove('visible');
  summary.innerHTML = '';
  resetNavButtons();

  if (!provider) {
    dateSelect.disabled = true;
    return;
  }

  dateSelect.disabled = false;

  const dates = [...new Set(
    data.articles
      .filter(a => a.provider === provider)
      .map(a => a.date.substring(0,10))
  )].sort();

  dates.forEach(dateStr => {
    const opt = document.createElement('option');
    opt.value = dateStr;
    opt.textContent = dateStr;
    dateSelect.appendChild(opt);
  });

  if (selectedDate && dates.includes(selectedDate)) {
    dateSelect.value = selectedDate;
    updateArticles(provider, selectedDate);
  }
}

function updateArticles(provider, date) {
  articleSelect.innerHTML = '<option value="">-- Choisir un article --</option>';
  viewer.textContent = 'S√©lectionnez un article pour l‚Äôafficher ici.';
  summary.classList.remove('visible');
  summary.innerHTML = '';
  resetNavButtons();

  if (!date) {
    articleSelect.disabled = true;
    return;
  }

  articleSelect.disabled = false;

  currentArticles = data.articles.filter(a =>
    a.provider === provider &&
    a.date.startsWith(date)
  );

  currentArticles.forEach((article, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = article.titre;
    articleSelect.appendChild(opt);
  });

  if (currentArticles.length > 0) {
    currentIndex = 0;
    articleSelect.value = 0;
    displayArticle(currentIndex);
  }
}

function displayArticle(index) {
  if (index < 0 || index >= currentArticles.length) {
    viewer.textContent = 'Article introuvable.';
    return;
  }
  const article = currentArticles[index];
  viewer.textContent = article.text;
   viewer.innerHTML = `
    <div>
      <p style="font-size:0.9rem; color: #666; margin-bottom:10px;">
        üóìÔ∏è <strong>Scraping :</strong> ${new Date(article.scraping_date).toLocaleString('fr-FR')}
      </p>
      <div>${article.text}</div>
    </div>
  `;
  
  summary.classList.remove('visible');
  summary.innerHTML = '';

  prevBtn.disabled = index === 0;
  nextBtn.disabled = index === currentArticles.length - 1;
  summarizeBtn.disabled = false;
}

function resetNavButtons() {
  prevBtn.disabled = true;
  nextBtn.disabled = true;
  summarizeBtn.disabled = true;
}

/* ==== PROMPT BUILDER ==== */
function buildPrompt(title, text) {
  return `
Tu es journaliste sp√©cialis√© dans la veille strat√©gique. 
Fournis un r√©sum√© clair et structur√© en utilisant UNIQUEMENT des balises HTML (<h3>, <ul>, <li>, <p>).

Structure attendue :
<h3>üîç En un coup d'≈ìil</h3>
<ul>
<li>3 √† 5 points cl√©s</li>
</ul>

Puis :
<h3>[Nom de la cat√©gorie]</h3>
<p>Texte synth√©tique et clair</p>

Titre : ${title}
Texte :
${text}
`;
}

/* ==== GEMINI ==== */
async function callGemini(prompt) {
  while (currentKeyIndex < API_KEYS.length) {
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEYS[currentKeyIndex]}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ role: "user", parts: [{ text: prompt }] }]
        })
      });

      if (response.status === 429) {
        console.warn(`‚ö†Ô∏è Quota d√©pass√© pour la cl√© ${currentKeyIndex + 1}`);
        currentKeyIndex++;
        continue;
      }

      if (!response.ok) throw new Error(`API error status: ${response.status}`);

      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "[Pas de texte g√©n√©r√©]";
    } catch (err) {
      console.error(`Erreur Gemini avec cl√© ${currentKeyIndex + 1} :`, err);
      currentKeyIndex++;
    }
  }
  return "[Toutes les cl√©s API sont √©puis√©es]";
}

/* ==== EVENTS ==== */
providerSelect.addEventListener('change', () => {
  updateDates(providerSelect.value);
});

dateSelect.addEventListener('change', () => {
  updateArticles(providerSelect.value, dateSelect.value);
});

articleSelect.addEventListener('change', () => {
  currentIndex = parseInt(articleSelect.value, 10);
  displayArticle(currentIndex);
});

prevBtn.addEventListener('click', () => {
  if (currentIndex > 0) {
    currentIndex--;
    articleSelect.value = currentIndex;
    displayArticle(currentIndex);
  }
});

nextBtn.addEventListener('click', () => {
  if (currentIndex < currentArticles.length - 1) {
    currentIndex++;
    articleSelect.value = currentIndex;
    displayArticle(currentIndex);
  }
});

summarizeBtn.addEventListener('click', async () => {
  if (currentIndex === -1) return;
  summarizeBtn.disabled = true;
  summarizeBtn.textContent = "üïê R√©sum√© en cours...";
  const article = currentArticles[currentIndex];
  const prompt = buildPrompt(article.titre, article.text);

  try {
    const summaryText = await callGemini(prompt);
    // Nettoyage pour enlever ```html et ```
    const cleanedSummary = summaryText.replace(/```html?\n?/g,'').replace(/```/g, '').trim();
    summary.innerHTML = cleanedSummary;

    summary.classList.add('visible');
    summary.scrollIntoView({ behavior: 'smooth' });
  } catch (e) {
    summary.innerHTML = "<p><strong>Erreur :</strong> " + e.message + "</p>";
    summary.classList.add('visible');
  } finally {
    summarizeBtn.disabled = false;
    summarizeBtn.textContent = "üìù R√©sumer";
  }
});

const generateNarrativesBtn = document.getElementById('generateNarrativesBtn');
const narrativesDiv = document.getElementById('narratives');

generateNarrativesBtn.addEventListener('click', async () => {
  if (currentIndex === -1) return;

  generateNarrativesBtn.disabled = true;
  generateNarrativesBtn.textContent = "üïê G√©n√©ration en cours...";

  const article = currentArticles[currentIndex];
  const synthText = article.text;

  if (!synthText) {
    narrativesDiv.textContent = "‚ö†Ô∏è Aucun texte disponible pour g√©n√©rer les narratifs.";
    generateNarrativesBtn.disabled = false;
    generateNarrativesBtn.textContent = "üó£Ô∏è G√©n√©rer narratifs";
    return;
  }

  let html = "";
  for (const [style, instruction] of Object.entries(NARRATIVE_STYLES)) {
    const prompt = `
Contexte : ${synthText}

üéØ Objectif : ${instruction}
‚ö†Ô∏è Contraintes :
- Limite de 280 caract√®res
- Pas d'√©motic√¥nes autres que celles donn√©es
- Pas de hashtags
- Pas de noms de personnes ou lieux pr√©cis
- Pas d'appels √† l'action
- Texte compr√©hensible et clair

√âcris un tweet dans ce style :`;

    try {
      const tweet = await callGemini(prompt);
      html += `<h3>${style}</h3><p>${tweet}</p><hr>`;
    } catch (err) {
      html += `<h3>${style}</h3><p>Erreur lors de la g√©n√©ration.</p><hr>`;
    }
  }

  narrativesDiv.innerHTML = html;
  generateNarrativesBtn.disabled = false;
  generateNarrativesBtn.textContent = "üó£Ô∏è G√©n√©rer narratifs";
});
summarizeBtn.disabled = false;
generateNarrativesBtn.disabled = false;

</script>

</body>
</html>

